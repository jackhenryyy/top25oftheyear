<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Year in Music</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --card: #141414;
      --accent: #1DB954;
      --text: #ffffff;
      --muted: #888;
      --tile: 90px;
      --gap: 8px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      padding: 40px 20px 30px;
    }

    h1 {
      font-family: 'Instrument Serif', serif;
      font-size: clamp(2.5rem, 8vw, 4.5rem);
      font-weight: 400;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff 0%, #1DB954 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: var(--muted);
      font-size: 14px;
    }

    /* Upload Section */
    .upload-section {
      background: var(--card);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid #222;
    }

    .upload-section h2 {
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .upload-section h2::before {
      content: "ðŸŽµ";
    }

    .file-input-wrap {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    input[type="file"] {
      background: #222;
      border: 2px dashed #444;
      border-radius: 8px;
      padding: 15px;
      color: var(--text);
      font-family: inherit;
      cursor: pointer;
      flex: 1;
      min-width: 200px;
    }

    input[type="file"]:hover {
      border-color: var(--accent);
    }

    .btn {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 15px 25px;
      border-radius: 8px;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s;
    }

    .btn:hover {
      transform: scale(1.02);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid #444;
    }

    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .status {
      margin-top: 15px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Main Content Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 30px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Songs Pyramid */
    .songs-section {
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid #222;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h2 {
      font-size: 18px;
    }

    .helper-text {
      font-size: 12px;
      color: var(--muted);
    }

    .pyramid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }

    .pyr-row {
      display: flex;
      justify-content: center;
      gap: var(--gap);
    }

    .tile {
      width: var(--tile);
      height: var(--tile);
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      background: #222;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .tile:hover {
      transform: scale(1.08);
      z-index: 10;
    }

    .tile.playing {
      box-shadow: 0 0 0 3px var(--accent), 0 10px 40px rgba(29, 185, 84, 0.3);
    }

    .tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tile .rank {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tile:hover .rank {
      opacity: 1;
    }

    .tile.hero {
      width: calc(var(--tile) * 2.5);
      height: calc(var(--tile) * 2.5);
      border-radius: 12px;
    }

    .tile.hero .rank {
      font-size: 14px;
      padding: 4px 8px;
    }

    /* Now Playing */
    .now-playing {
      text-align: center;
      margin-top: 20px;
      padding: 15px;
      background: #1a1a1a;
      border-radius: 8px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .now-playing .song-title {
      font-weight: 700;
      color: var(--accent);
    }

    .now-playing .song-artist {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Albums Section */
    .albums-section {
      background: var(--card);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid #222;
    }

    .albums-section h2 {
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .albums-section h2::before {
      content: "ðŸ’¿";
    }

    .album-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .album-input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .album-input-row span {
      width: 24px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .album-input-row input {
      flex: 1;
      background: #222;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
    }

    .album-input-row input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .album-input-row input::placeholder {
      color: #555;
    }

    .load-albums-btn {
      margin-top: 15px;
      width: 100%;
    }

    /* Album Grid Display */
    .album-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .album-tile {
      aspect-ratio: 1;
      background: #222;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
    }

    .album-tile:hover {
      transform: scale(1.05);
    }

    .album-tile.playing {
      box-shadow: 0 0 0 3px var(--accent);
    }

    .album-tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .album-tile .album-rank {
      position: absolute;
      top: 6px;
      left: 6px;
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 6px;
      border-radius: 4px;
    }

    /* Hidden states */
    .hidden { display: none !important; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      :root {
        --tile: 60px;
      }
      .tile.hero {
        width: calc(var(--tile) * 2);
        height: calc(var(--tile) * 2);
      }
    }

    /* Loading placeholder */
    .tile-placeholder {
      background: linear-gradient(90deg, #222 25%, #333 50%, #222 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>My Year in Music</h1>
      <p class="subtitle">Upload your Spotify export to create a shareable music recap</p>
    </header>

    <!-- Upload Section -->
    <section class="upload-section" id="uploadSection">
      <h2>Import Your Top 25 Songs</h2>
      <div class="file-input-wrap">
        <input type="file" id="csvFile" accept=".csv">
        <button class="btn" id="buildBtn">Build Showcase</button>
        <button class="btn btn-ghost" id="resetBtn">Reset</button>
      </div>
      <p class="status" id="status">Export your Spotify playlist as CSV and upload it here</p>
    </section>

    <!-- Main Content -->
    <div class="main-grid">
      <!-- Songs Section -->
      <section class="songs-section hidden" id="songsSection">
        <div class="section-header">
          <h2>ðŸŽµ Top 25 Songs</h2>
          <span class="helper-text">Click to play preview</span>
        </div>
        <div class="pyramid" id="pyramid"></div>
        <div class="now-playing" id="nowPlaying">
          <span style="color: var(--muted)">Click a song to play</span>
        </div>
      </section>

      <!-- Albums Section -->
      <section class="albums-section">
        <h2>Top 10 Albums</h2>
        <div class="album-inputs" id="albumInputs"></div>
        <button class="btn load-albums-btn" id="loadAlbumsBtn">Load Album Art</button>
        <div class="album-grid hidden" id="albumGrid"></div>
      </section>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>
  <audio id="audio" preload="none"></audio>

  <script>
    // ===== ELEMENTS =====
    const $ = id => document.getElementById(id);
    const csvFile = $('csvFile');
    const buildBtn = $('buildBtn');
    const resetBtn = $('resetBtn');
    const status = $('status');
    const uploadSection = $('uploadSection');
    const songsSection = $('songsSection');
    const pyramid = $('pyramid');
    const nowPlaying = $('nowPlaying');
    const albumInputs = $('albumInputs');
    const loadAlbumsBtn = $('loadAlbumsBtn');
    const albumGrid = $('albumGrid');
    const toast = $('toast');
    const audio = $('audio');

    // ===== STATE =====
    let tracks = [];
    let currentPlaying = null;

    // ===== INIT ALBUM INPUTS =====
    function initAlbumInputs() {
      albumInputs.innerHTML = '';
      for (let i = 1; i <= 10; i++) {
        const row = document.createElement('div');
        row.className = 'album-input-row';
        row.innerHTML = `
          <span>#${i}</span>
          <input type="text" placeholder="Artist - Album Name" data-index="${i}">
        `;
        albumInputs.appendChild(row);
      }
    }
    initAlbumInputs();

    // ===== TOAST =====
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      clearTimeout(showToast.t);
      showToast.t = setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    // ===== CSV PARSING =====
    function parseCSV(text) {
      if (!text) return [];
      text = text.replace(/^\uFEFF/, '');
      const rows = [];
      let row = [], cell = '', inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i], next = text[i + 1];
        if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }
        if (ch === ',' && !inQuotes) { row.push(cell); cell = ''; continue; }
        if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && next === '\n') i++;
          row.push(cell); cell = '';
          if (row.some(c => c.trim())) rows.push(row);
          row = [];
          continue;
        }
        cell += ch;
      }
      row.push(cell);
      if (row.some(c => c.trim())) rows.push(row);
      return rows;
    }

    function extractTracks(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];

      const header = rows[0].map(h => h.toLowerCase().trim());
      const trackIdx = header.findIndex(h => h.includes('track name'));
      const artistIdx = header.findIndex(h => h.includes('artist'));
      const albumIdx = header.findIndex(h => h.includes('album'));

      if (trackIdx === -1 || artistIdx === -1) return [];

      const out = [];
      for (let i = 1; i < rows.length && out.length < 25; i++) {
        const cells = rows[i];
        const track = (cells[trackIdx] || '').trim();
        const artist = (cells[artistIdx] || '').trim();
        const album = albumIdx !== -1 ? (cells[albumIdx] || '').trim() : '';
        if (track && artist) out.push({ track, artist, album });
      }
      return out;
    }

    // ===== iTUNES API (JSONP for sandbox compatibility) =====
    let jsonpCounter = 0;
    
    function jsonpFetch(url) {
      return new Promise((resolve, reject) => {
        const callbackName = `itunes_cb_${jsonpCounter++}_${Date.now()}`;
        const script = document.createElement('script');
        
        const cleanup = () => {
          delete window[callbackName];
          script.remove();
        };
        
        window[callbackName] = (data) => {
          cleanup();
          resolve(data);
        };
        
        script.onerror = () => {
          cleanup();
          reject(new Error('JSONP request failed'));
        };
        
        script.src = `${url}&callback=${callbackName}`;
        document.head.appendChild(script);
        
        // Timeout after 10s
        setTimeout(() => {
          if (window[callbackName]) {
            cleanup();
            reject(new Error('JSONP timeout'));
          }
        }, 10000);
      });
    }

    async function searchItunes(track, artist) {
      const term = `${track} ${artist.split(',')[0]}`;
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(term)}&entity=song&limit=3`;
      try {
        const data = await jsonpFetch(url);
        if (data.results?.length) {
          const best = data.results[0];
          return {
            artwork: (best.artworkUrl100 || '').replace('100x100bb', '300x300bb'),
            preview: best.previewUrl || '',
            trackName: best.trackName,
            artistName: best.artistName
          };
        }
      } catch (e) {
        console.error('iTunes search failed:', e);
      }
      return null;
    }

    async function searchAlbum(query) {
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=3`;
      try {
        const data = await jsonpFetch(url);
        if (data.results?.length) {
          const best = data.results[0];
          return {
            artwork: (best.artworkUrl100 || '').replace('100x100bb', '600x600bb'),
            albumName: best.collectionName,
            artistName: best.artistName
          };
        }
      } catch (e) {
        console.error('Album search failed:', e);
      }
      return null;
    }

    // ===== AUDIO =====
    function stopAudio() {
      audio.pause();
      audio.src = '';
      if (currentPlaying) {
        currentPlaying.tile.classList.remove('playing');
        currentPlaying = null;
      }
      nowPlaying.innerHTML = '<span style="color: var(--muted)">Click a song to play</span>';
    }

    function playTrack(index, tile) {
      const t = tracks[index];
      if (!t?.preview) {
        showToast('No preview available');
        return;
      }

      if (currentPlaying?.index === index) {
        stopAudio();
        return;
      }

      stopAudio();
      currentPlaying = { index, tile };
      tile.classList.add('playing');
      audio.src = t.preview;
      audio.play().catch(() => {});
      
      nowPlaying.innerHTML = `
        <div class="song-title">${t.trackName || t.track}</div>
        <div class="song-artist">${t.artistName || t.artist}</div>
      `;
    }

    audio.addEventListener('ended', stopAudio);

    // ===== BUILD PYRAMID =====
    // Pyramid rows: 1, 3, 5, 7, 9 = 25 tiles total
    const PYRAMID_ROWS = [1, 3, 5, 7, 9];

    function buildPyramid() {
      pyramid.innerHTML = '';
      let idx = 0;

      PYRAMID_ROWS.forEach((count, rowIdx) => {
        const row = document.createElement('div');
        row.className = 'pyr-row';

        for (let i = 0; i < count && idx < 25; i++) {
          const tile = document.createElement('div');
          tile.className = 'tile' + (idx === 0 ? ' hero' : '');
          tile.dataset.index = idx;

          const t = tracks[idx];
          if (t?.artwork) {
            tile.innerHTML = `
              <img src="${t.artwork}" alt="${t.track}">
              <span class="rank">#${idx + 1}</span>
            `;
          } else {
            tile.innerHTML = `<span class="rank">#${idx + 1}</span>`;
            tile.classList.add('tile-placeholder');
          }

          tile.addEventListener('click', () => playTrack(parseInt(tile.dataset.index), tile));
          row.appendChild(tile);
          idx++;
        }

        pyramid.appendChild(row);
      });
    }

    // ===== MAIN BUILD =====
    async function handleBuild() {
      const file = csvFile.files?.[0];
      if (!file) {
        status.textContent = 'Please select a CSV file first';
        return;
      }

      status.textContent = 'Reading file...';
      const text = await file.text();
      const parsed = extractTracks(text);

      if (!parsed.length) {
        status.textContent = 'Could not find track data in CSV. Make sure it has Track Name and Artist columns.';
        return;
      }

      status.textContent = `Found ${parsed.length} tracks. Loading artwork...`;
      
      // Initialize tracks with parsed data
      tracks = parsed.map(p => ({ ...p, artwork: '', preview: '' }));
      
      // Show the section with placeholders
      songsSection.classList.remove('hidden');
      buildPyramid();

      // Fetch artwork progressively
      let successCount = 0;
      for (let i = 0; i < tracks.length; i++) {
        try {
          const result = await searchItunes(tracks[i].track, tracks[i].artist);
          if (result) {
            tracks[i] = { ...tracks[i], ...result };
            successCount++;
            // Update just this tile
            const tile = pyramid.querySelector(`[data-index="${i}"]`);
            if (tile) {
              tile.classList.remove('tile-placeholder');
              tile.innerHTML = `
                <img src="${result.artwork}" alt="${tracks[i].track}">
                <span class="rank">#${i + 1}</span>
              `;
            }
          }
        } catch (e) {
          // API blocked in sandbox - continue without artwork
        }
        status.textContent = `Loading... ${i + 1}/${tracks.length}`;
      }

      if (successCount === 0) {
        status.textContent = 'Artwork blocked in preview - deploy to GitHub Pages to see full version!';
        showToast('Deploy to GitHub to load artwork');
        // Still show track names on hover
        tracks.forEach((t, i) => {
          const tile = pyramid.querySelector(`[data-index="${i}"]`);
          if (tile) {
            tile.title = `${t.track} - ${t.artist}`;
            tile.classList.remove('tile-placeholder');
            tile.style.background = `hsl(${(i * 14) % 360}, 50%, 25%)`;
          }
        });
      } else {
        status.textContent = 'Done! Click any song to play a preview.';
        showToast('Showcase ready!');
      }
    }

    function handleReset() {
      stopAudio();
      csvFile.value = '';
      tracks = [];
      pyramid.innerHTML = '';
      songsSection.classList.add('hidden');
      albumGrid.classList.add('hidden');
      albumGrid.innerHTML = '';
      initAlbumInputs();
      status.textContent = 'Export your Spotify playlist as CSV and upload it here';
    }

    // ===== ALBUMS =====
    async function handleLoadAlbums() {
      const inputs = albumInputs.querySelectorAll('input');
      const queries = Array.from(inputs).map(inp => inp.value.trim()).filter(Boolean);

      if (!queries.length) {
        showToast('Enter at least one album');
        return;
      }

      showToast('Loading album art...');
      albumGrid.innerHTML = '';
      albumGrid.classList.remove('hidden');

      for (let i = 0; i < queries.length; i++) {
        const result = await searchAlbum(queries[i]);
        const tile = document.createElement('div');
        tile.className = 'album-tile';
        
        if (result?.artwork) {
          tile.innerHTML = `
            <img src="${result.artwork}" alt="${result.albumName}">
            <span class="album-rank">#${i + 1}</span>
          `;
          tile.title = `${result.albumName} - ${result.artistName}`;
        } else {
          tile.innerHTML = `<span class="album-rank">#${i + 1}</span>`;
          tile.style.background = '#333';
        }

        albumGrid.appendChild(tile);
      }

      showToast('Albums loaded!');
    }

    // ===== EVENT LISTENERS =====
    buildBtn.addEventListener('click', handleBuild);
    resetBtn.addEventListener('click', handleReset);
    loadAlbumsBtn.addEventListener('click', handleLoadAlbums);

    console.log('[Year in Music] Ready!');
  </script>
</body>
</html>

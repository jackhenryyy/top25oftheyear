<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025</title>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f0;
      --text: #111;
      --muted: #888;
      --border: #111;
      --green: #7ecb8b;
      --green-dark: #5eb36d;
      --pink: #f28b82;
      --spotify: #1DB954;
      --tile: 80px;
      --gap: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier Prime', 'Courier New', monospace;
      padding-bottom: 80px;
    }

    .hidden { display: none !important; }

    /* Header */
    .header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      letter-spacing: 8px;
      font-weight: 400;
    }

    /* Upload/Connect Section */
    .upload-section {
      max-width: 500px;
      margin: 60px auto;
      padding: 0 20px;
      text-align: center;
    }

    .upload-section h1 {
      font-size: 24px;
      letter-spacing: 6px;
      font-weight: 400;
      margin-bottom: 30px;
    }

    .upload-box {
      border: 2px solid var(--border);
      padding: 30px;
      background: #fff;
    }

    .btn {
      padding: 12px 24px;
      border: 2px solid var(--border);
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
      background: #fff;
    }

    .btn:hover { background: #f0f0f0; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-green {
      background: var(--green);
    }
    .btn-green:hover { background: var(--green-dark); }

    .btn-spotify {
      background: var(--spotify);
      color: white;
      border-color: var(--spotify);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      padding: 14px 28px;
    }
    .btn-spotify:hover { background: #1ed760; }

    .btn-spotify svg {
      width: 24px;
      height: 24px;
    }

    .status {
      margin-top: 15px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Source Selection */
    .source-selection {
      margin: 20px 0;
    }

    .source-btn {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      text-align: left;
      background: #fff;
      border: 2px solid var(--border);
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
      transition: all 0.15s;
    }

    .source-btn:hover {
      background: var(--green);
    }

    .source-btn .source-title {
      font-weight: 700;
    }

    .source-btn .source-desc {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Playlist List */
    .playlist-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid var(--border);
      margin-top: 15px;
    }

    .playlist-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.15s;
    }

    .playlist-item:hover {
      background: var(--green);
    }

    .playlist-item:last-child {
      border-bottom: none;
    }

    .playlist-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border: 1px solid var(--border);
      background: #eee;
    }

    .playlist-info {
      flex: 1;
      text-align: left;
    }

    .playlist-name {
      font-weight: 700;
      font-size: 14px;
    }

    .playlist-tracks {
      font-size: 12px;
      color: var(--muted);
    }

    /* Settings Row */
    .settings-row {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .settings-row label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .search-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      font-family: inherit;
      font-size: 14px;
      background: #fff;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--green);
    }

    /* Share Bar */
    .share-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
    }

    /* Main Layout */
    .main-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 40px;
      padding: 20px;
    }

    /* Songs Section */
    .songs-section {
      width: 100%;
      max-width: 600px;
    }

    .section-title {
      text-align: center;
      font-size: 20px;
      letter-spacing: 6px;
      font-weight: 400;
      margin-bottom: 20px;
    }

    /* Pyramid */
    .pyramid-container {
      overflow-x: auto;
      padding: 10px;
      width: 100%;
    }

    .pyramid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
      min-width: fit-content;
    }

    .pyramid-row {
      display: flex;
      gap: var(--gap);
      justify-content: center;
    }

    .tile {
      width: var(--tile);
      height: var(--tile);
      border: 2px solid var(--border);
      background-size: cover;
      background-position: center;
      position: relative;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .tile:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10;
    }

    .tile.hero {
      width: calc(var(--tile) * 2);
      height: calc(var(--tile) * 2);
    }

    .tile.playing {
      box-shadow: 0 0 0 3px var(--green);
    }

    .rank-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      background: #fff;
      border: 1px solid var(--border);
      font-size: 10px;
      padding: 2px 4px;
      font-weight: 700;
    }

    .tile.hero .rank-badge {
      font-size: 12px;
    }

    /* Now Playing */
    .now-playing {
      text-align: center;
      padding: 15px;
      font-size: 13px;
      min-height: 50px;
    }

    /* Albums Section */
    .albums-section {
      width: 90%;
      max-width: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .album-strip-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .album-strip {
      width: 100%;
      height: 70px;
      border: 2px solid var(--border);
      border-top: none;
      background-size: cover;
      background-position: center;
      position: relative;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .album-strip:first-child {
      border-top: 2px solid var(--border);
    }

    .album-strip:hover {
      opacity: 0.9;
    }

    .album-strip .rank-badge {
      top: 8px;
      left: 8px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--bg);
      padding: 12px 24px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .toast.show {
      opacity: 1;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }

    .modal {
      background: var(--bg);
      border: 2px solid var(--border);
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 2px solid var(--border);
    }

    .modal-header h3 {
      font-size: 16px;
      letter-spacing: 2px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0 5px;
    }

    .modal-body {
      padding: 15px;
    }

    /* Search Results */
    .search-results {
      margin-top: 15px;
    }

    .search-result {
      display: flex;
      gap: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .search-result:hover {
      background: var(--green);
    }

    .search-result-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
    }

    .search-result-info {
      flex: 1;
    }

    .search-result-name {
      font-weight: 700;
      font-size: 13px;
    }

    .search-result-artist {
      font-size: 12px;
      color: var(--muted);
    }

    .search-hint {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
    }

    /* Album Links Modal */
    .album-links-modal .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .album-link-btn {
      display: block;
      width: 100%;
      padding: 15px;
      text-align: center;
      border: 2px solid var(--border);
      background: #fff;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      color: var(--text);
      transition: background 0.15s;
    }

    .album-link-btn:hover {
      background: var(--green);
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: #fff;
      border: 2px solid var(--border);
      z-index: 200;
      min-width: 150px;
    }

    .context-menu-item {
      padding: 12px 15px;
      cursor: pointer;
      font-size: 14px;
    }

    .context-menu-item:hover {
      background: var(--green);
    }

    /* Responsive */
    @media (max-width: 600px) {
      :root {
        --tile: 38px;
        --gap: 3px;
      }

      .tile.hero {
        width: calc(var(--tile) * 2);
        height: calc(var(--tile) * 2);
      }

      .rank-badge {
        font-size: 8px;
        padding: 1px 3px;
      }

      .section-title {
        font-size: 18px;
      }

      .now-playing {
        font-size: 11px;
      }

      .btn {
        font-size: 12px;
        padding: 10px 16px;
      }

      .upload-section h1 {
        font-size: 20px;
      }
    }

    @media (max-width: 400px) {
      :root {
        --tile: 32px;
        --gap: 2px;
      }
    }

    @media (min-width: 900px) {
      :root {
        --tile: 90px;
      }
    }

    @media (min-width: 1200px) {
      :root {
        --tile: 100px;
      }
    }

    /* Back button */
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 50;
    }

    /* User info */
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }

    .logout-link {
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    .logout-link:hover {
      color: var(--text);
    }
  </style>
</head>
<body>
  <!-- Header (shown when logged in) -->
  <header class="header hidden" id="header">
    <div class="logo" id="headerLogo">2 0 2 5</div>
    <div class="user-info" id="userInfo">
      <img class="user-avatar" id="userAvatar" src="" alt="">
      <span id="userName"></span>
      <span class="logout-link" id="logoutBtn">logout</span>
    </div>
  </header>

  <!-- Connect Section -->
  <section class="upload-section" id="connectSection">
    <h1>2 0 2 5</h1>
    <div class="upload-box">
      <p style="margin-bottom: 20px; font-size: 14px;">create your top 25 songs pyramid</p>
      <button class="btn btn-spotify" id="connectBtn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        connect spotify
      </button>
      <p class="status" id="status">connect your spotify to get started</p>
    </div>
  </section>

  <!-- Source Selection Section -->
  <section class="upload-section hidden" id="sourceSection">
    <h1>2 0 2 5</h1>
    <div class="upload-box">
      <p style="margin-bottom: 15px; font-size: 14px;">choose your source</p>
      
      <div class="source-selection">
        <button class="source-btn" id="topTracksBtn">
          <div class="source-title">your top tracks</div>
          <div class="source-desc">your most played songs on spotify</div>
        </button>
        <button class="source-btn" id="playlistBtn">
          <div class="source-title">from a playlist</div>
          <div class="source-desc">pick any of your playlists</div>
        </button>
      </div>
    </div>
  </section>

  <!-- Playlist Selection Section -->
  <section class="upload-section hidden" id="playlistSection">
    <h1>2 0 2 5</h1>
    <div class="upload-box">
      <p style="margin-bottom: 15px; font-size: 14px;">select a playlist</p>
      <div class="playlist-list" id="playlistList"></div>
      <button class="btn" id="backToSourceBtn" style="margin-top: 15px;">← back</button>
    </div>
  </section>

  <!-- Settings Section (before build) -->
  <section class="upload-section hidden" id="settingsSection">
    <h1>2 0 2 5</h1>
    <div class="upload-box">
      <p style="margin-bottom: 10px; font-size: 14px;" id="settingsSource"></p>
      <input type="text" id="titleInput" class="search-input" placeholder="title (e.g. 2025, summer vibes)" style="text-align:center; margin-bottom: 15px;">
      
      <div class="settings-row">
        <label><input type="checkbox" id="showSongsCheck" checked> show songs</label>
        <label><input type="checkbox" id="showAlbumsCheck" checked> show albums</label>
      </div>
      
      <button class="btn btn-green" id="buildBtn" style="width: 100%; margin-top: 10px;">build showcase</button>
      <button class="btn" id="backToPlaylistBtn" style="width: 100%; margin-top: 10px;">← back</button>
    </div>
  </section>

  <!-- Showcase Section -->
  <section class="hidden" id="showcaseSection">
    <button class="btn back-btn hidden" id="backBtn">← back</button>
    
    <div class="share-bar">
      <span id="ownerName" style="font-size: 18px; font-weight: 700; letter-spacing: 2px;"></span>
    </div>
    <div class="share-bar">
      <button class="btn btn-green" id="saveBtn">save & get share link</button>
    </div>

    <div class="main-layout">
      <!-- Songs -->
      <div class="songs-section" id="songsSection">
        <h2 class="section-title">SONGS</h2>
        <div class="pyramid-container">
          <div class="pyramid" id="pyramid"></div>
        </div>
        <div class="now-playing" id="nowPlaying">
          <span style="color: var(--muted)">click to play · right-click to fix</span>
        </div>
      </div>

      <!-- Albums -->
      <div class="albums-section" id="albumsSection">
        <h2 class="section-title">ALBUMS</h2>
        <div class="album-strip-container" id="albumContainer"></div>
      </div>
    </div>
  </section>

  <!-- Context Menu -->
  <div class="context-menu hidden" id="contextMenu">
    <div class="context-menu-item" id="fixSongBtn">fix this song</div>
  </div>

  <!-- Fix Song Modal -->
  <div class="modal-overlay hidden" id="fixModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Fix Song</h3>
        <button class="modal-close" id="fixModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" class="search-input" id="fixSearchInput" placeholder="search spotify...">
        <div class="search-results" id="fixSearchResults"></div>
        <p class="search-hint" id="fixHint">type to search</p>
      </div>
    </div>
  </div>

  <!-- Album Search Modal -->
  <div class="modal-overlay hidden" id="albumModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Album</h3>
        <button class="modal-close" id="albumModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" class="search-input" id="albumSearchInput" placeholder="search spotify...">
        <div class="search-results" id="albumSearchResults"></div>
        <p class="search-hint" id="albumHint">type to search</p>
      </div>
    </div>
  </div>

  <!-- Album Links Modal -->
  <div class="modal-overlay hidden" id="albumLinksModal">
    <div class="modal album-links-modal">
      <div class="modal-header">
        <h3 id="albumLinksTitle">Open Album</h3>
        <button class="modal-close" id="albumLinksClose">&times;</button>
      </div>
      <div class="modal-body">
        <a class="album-link-btn" id="openSpotifyBtn" href="#" target="_blank">Open in Spotify</a>
        <a class="album-link-btn" id="openAppleBtn" href="#" target="_blank">Open in Apple Music</a>
      </div>
    </div>
  </div>

  <div class="toast hidden" id="toast"></div>
  <audio id="audio" preload="none"></audio>

  <script>
    // LZ-String compression library (MIT License)
    var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",t={},i={compressToBase64:function(o){if(null==o)return"";var r=i._compress(o,6,function(o){return n.charAt(o)});switch(r.length%4){default:case 0:return r;case 1:return r+"===";case 2:return r+"==";case 3:return r+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(e){return o(n,r.charAt(e))})},compressToEncodedURIComponent:function(o){return null==o?"":i._compress(o,6,function(o){return e.charAt(o)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(n){return o(e,r.charAt(n))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(o,r,n){if(null==o)return"";var e,t,i,s={},p={},u="",c="",a="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<o.length;i+=1)if(u=o.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(e=0;h>e;e++)m<<=1,v==r-1?(v=0,d.push(n(m)),m=0):v++;for(t=a.charCodeAt(0),e=0;8>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;h>e;e++)m=m<<1|t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=a.charCodeAt(0),e=0;16>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}l--,0==l&&(l=Math.pow(2,h),h++),delete p[a]}else for(t=s[a],e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;l--,0==l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;h>e;e++)m=m<<1|1&t,v==r-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==r-1){d.push(n(m));break}v++}return d.join("")},decompress:function(o){return null==o?"":""==o?null:i._decompress(o.length,32768,function(r){return o.charCodeAt(r)})},_decompress:function(o,n,e){var t,i,s,p,u,c,a,l,f=[],h=4,d=4,m=3,v="",w=[],A={val:e(0),position:n,index:1};for(i=0;3>i;i+=1)f[i]=i;for(p=0,c=Math.pow(2,2),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(t=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;l=r(p);break;case 2:return""}for(f[3]=l,s=l,w.push(l);;){if(A.index>o)return"";for(p=0,c=Math.pow(2,m),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;switch(l=p){case 0:for(p=0,c=Math.pow(2,8),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 1:for(p=0,c=Math.pow(2,16),a=1;a!=c;)u=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=e(A.index++)),p|=(u>0?1:0)*a,a<<=1;f[d++]=r(p),l=d-1,h--;break;case 2:return w.join("")}if(0==h&&(h=Math.pow(2,m),m++),f[l])v=f[l];else{if(l!==d)return null;v=s+s.charAt(0)}w.push(v),f[d++]=s+v.charAt(0),h--,s=v,0==h&&(h=Math.pow(2,m),m++)}}};return i}();

    // ===== SPOTIFY CONFIG =====
    const SPOTIFY_CLIENT_ID = 'e2f21f60cba34b9f9742920b125dc240';
    const SPOTIFY_REDIRECT_URI = 'https://jackhenryyy.github.io/top25oftheyear';
    const SPOTIFY_SCOPES = 'user-read-private user-top-read playlist-read-private playlist-read-collaborative';

    // ===== ELEMENTS =====
    const $ = id => document.getElementById(id);
    const header = $('header');
    const headerLogo = $('headerLogo');
    const userAvatar = $('userAvatar');
    const userNameEl = $('userName');
    const logoutBtn = $('logoutBtn');
    const connectSection = $('connectSection');
    const connectBtn = $('connectBtn');
    const sourceSection = $('sourceSection');
    const topTracksBtn = $('topTracksBtn');
    const playlistBtn = $('playlistBtn');
    const playlistSection = $('playlistSection');
    const playlistList = $('playlistList');
    const backToSourceBtn = $('backToSourceBtn');
    const settingsSection = $('settingsSection');
    const settingsSource = $('settingsSource');
    const titleInput = $('titleInput');
    const showSongsCheck = $('showSongsCheck');
    const showAlbumsCheck = $('showAlbumsCheck');
    const buildBtn = $('buildBtn');
    const backToPlaylistBtn = $('backToPlaylistBtn');
    const showcaseSection = $('showcaseSection');
    const backBtn = $('backBtn');
    const saveBtn = $('saveBtn');
    const ownerName = $('ownerName');
    const songsSection = $('songsSection');
    const albumsSection = $('albumsSection');
    const pyramid = $('pyramid');
    const albumContainer = $('albumContainer');
    const nowPlaying = $('nowPlaying');
    const status = $('status');
    const toast = $('toast');
    const audio = $('audio');
    const contextMenu = $('contextMenu');
    const fixSongBtn = $('fixSongBtn');
    const fixModal = $('fixModal');
    const fixModalClose = $('fixModalClose');
    const fixSearchInput = $('fixSearchInput');
    const fixSearchResults = $('fixSearchResults');
    const albumModal = $('albumModal');
    const albumModalClose = $('albumModalClose');
    const albumSearchInput = $('albumSearchInput');
    const albumSearchResults = $('albumSearchResults');
    const albumLinksModal = $('albumLinksModal');
    const albumLinksClose = $('albumLinksClose');
    const albumLinksTitle = $('albumLinksTitle');
    const openSpotifyBtn = $('openSpotifyBtn');
    const openAppleBtn = $('openAppleBtn');

    // ===== STATE =====
    let accessToken = null;
    let spotifyUser = null;
    let tracks = [];
    let albums = Array(10).fill(null);
    let showcaseTitle = '2025';
    let showSongs = true;
    let showAlbums = true;
    let isSharedView = false;
    let currentPlaying = null;
    let contextTarget = null;
    let albumTarget = null;
    let selectedSource = null;

    // ===== UTILITY =====
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, 2000);
    }

    // ===== SPOTIFY AUTH (PKCE) =====
    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode(...array))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function startSpotifyAuth() {
      const verifier = generateCodeVerifier();
      const challenge = await generateCodeChallenge(verifier);
      
      localStorage.setItem('spotify_verifier', verifier);
      
      const params = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        response_type: 'code',
        redirect_uri: SPOTIFY_REDIRECT_URI,
        scope: SPOTIFY_SCOPES,
        code_challenge_method: 'S256',
        code_challenge: challenge
      });
      
      window.location.href = `https://accounts.spotify.com/authorize?${params}`;
    }

    async function handleAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');
      
      if (error) {
        console.error('Auth error:', error);
        status.textContent = 'auth failed: ' + error;
        return false;
      }
      
      if (!code) return false;
      
      const verifier = localStorage.getItem('spotify_verifier');
      if (!verifier) {
        console.error('No verifier found');
        return false;
      }
      
      try {
        const response = await fetch('https://accounts.spotify.com/api/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID,
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: SPOTIFY_REDIRECT_URI,
            code_verifier: verifier
          })
        });
        
        const data = await response.json();
        
        if (data.access_token) {
          accessToken = data.access_token;
          localStorage.setItem('spotify_token', accessToken);
          localStorage.setItem('spotify_token_time', Date.now());
          localStorage.removeItem('spotify_verifier');
          
          window.history.replaceState({}, '', window.location.pathname);
          
          return true;
        }
      } catch (e) {
        console.error('Token exchange error:', e);
      }
      
      return false;
    }

    function checkStoredToken() {
      const token = localStorage.getItem('spotify_token');
      const tokenTime = localStorage.getItem('spotify_token_time');
      
      if (token && tokenTime) {
        const elapsed = Date.now() - parseInt(tokenTime);
        if (elapsed < 3500000) {
          accessToken = token;
          return true;
        }
      }
      return false;
    }

    function logout() {
      localStorage.removeItem('spotify_token');
      localStorage.removeItem('spotify_token_time');
      accessToken = null;
      spotifyUser = null;
      showSection('connect');
    }

    // ===== SPOTIFY API =====
    async function spotifyFetch(endpoint) {
      const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
      });
      
      if (response.status === 401) {
        logout();
        throw new Error('Token expired');
      }
      
      return response.json();
    }

    async function getSpotifyUser() {
      return spotifyFetch('/me');
    }

    async function getTopTracks(limit = 25) {
      const data = await spotifyFetch(`/me/top/tracks?limit=${limit}&time_range=medium_term`);
      return data.items;
    }

    async function getPlaylists() {
      const data = await spotifyFetch('/me/playlists?limit=50');
      return data.items;
    }

    async function getPlaylistTracks(playlistId, limit = 25) {
      const data = await spotifyFetch(`/playlists/${playlistId}/tracks?limit=${limit}`);
      return data.items.map(item => item.track).filter(t => t);
    }

    async function searchSpotify(query, type = 'track', limit = 10) {
      const data = await spotifyFetch(`/search?q=${encodeURIComponent(query)}&type=${type}&limit=${limit}`);
      return type === 'track' ? data.tracks.items : data.albums.items;
    }

    // ===== UI SECTIONS =====
    function showSection(section) {
      connectSection.classList.add('hidden');
      sourceSection.classList.add('hidden');
      playlistSection.classList.add('hidden');
      settingsSection.classList.add('hidden');
      showcaseSection.classList.add('hidden');
      header.classList.add('hidden');
      backBtn.classList.add('hidden');
      
      switch(section) {
        case 'connect':
          connectSection.classList.remove('hidden');
          break;
        case 'source':
          header.classList.remove('hidden');
          sourceSection.classList.remove('hidden');
          break;
        case 'playlist':
          header.classList.remove('hidden');
          playlistSection.classList.remove('hidden');
          break;
        case 'settings':
          header.classList.remove('hidden');
          settingsSection.classList.remove('hidden');
          break;
        case 'showcase':
          if (!isSharedView) {
            header.classList.remove('hidden');
            backBtn.classList.remove('hidden');
          }
          showcaseSection.classList.remove('hidden');
          break;
      }
    }

    async function showSourceSelection() {
      if (!spotifyUser) {
        try {
          spotifyUser = await getSpotifyUser();
          userNameEl.textContent = spotifyUser.display_name || 'User';
          if (spotifyUser.images?.[0]?.url) {
            userAvatar.src = spotifyUser.images[0].url;
          } else {
            userAvatar.style.display = 'none';
          }
        } catch (e) {
          console.error('Failed to get user:', e);
          logout();
          return;
        }
      }
      
      showSection('source');
    }

    async function showPlaylistSelection() {
      showSection('playlist');
      playlistList.innerHTML = '<p style="padding:20px;text-align:center;">loading playlists...</p>';
      
      try {
        const playlists = await getPlaylists();
        
        if (!playlists.length) {
          playlistList.innerHTML = '<p style="padding:20px;text-align:center;">no playlists found</p>';
          return;
        }
        
        playlistList.innerHTML = playlists.map(p => `
          <div class="playlist-item" data-id="${p.id}" data-name="${p.name}">
            <img class="playlist-img" src="${p.images?.[0]?.url || ''}" alt="">
            <div class="playlist-info">
              <div class="playlist-name">${p.name}</div>
              <div class="playlist-tracks">${p.tracks?.total || 0} tracks</div>
            </div>
          </div>
        `).join('');
        
        playlistList.querySelectorAll('.playlist-item').forEach(el => {
          el.addEventListener('click', () => {
            selectedSource = { type: 'playlist', id: el.dataset.id, name: el.dataset.name };
            showSettings();
          });
        });
      } catch (e) {
        console.error('Failed to load playlists:', e);
        playlistList.innerHTML = '<p style="padding:20px;text-align:center;">failed to load playlists</p>';
      }
    }

    function showSettings() {
      if (selectedSource.type === 'top') {
        settingsSource.textContent = 'source: your top 25 tracks';
        titleInput.value = '2025';
      } else {
        settingsSource.textContent = `source: ${selectedSource.name}`;
        titleInput.value = selectedSource.name;
      }
      showSection('settings');
    }

    // ===== BUILD SHOWCASE =====
    async function buildShowcase() {
      buildBtn.disabled = true;
      buildBtn.textContent = 'loading...';
      
      try {
        let spotifyTracks;
        
        if (selectedSource.type === 'top') {
          spotifyTracks = await getTopTracks(25);
        } else {
          spotifyTracks = await getPlaylistTracks(selectedSource.id, 25);
        }
        
        if (!spotifyTracks.length) {
          showToast('no tracks found');
          buildBtn.disabled = false;
          buildBtn.textContent = 'build showcase';
          return;
        }
        
        tracks = spotifyTracks.slice(0, 25).map(t => ({
          trackName: t.name,
          artistName: t.artists.map(a => a.name).join(', '),
          artwork: t.album?.images?.[0]?.url || '',
          preview: t.preview_url || '',
          spotifyUrl: t.external_urls?.spotify || '',
          albumName: t.album?.name || ''
        }));
        
        showcaseTitle = titleInput.value.trim() || '2025';
        showSongs = showSongsCheck.checked;
        showAlbums = showAlbumsCheck.checked;
        
        if (!showSongs && !showAlbums) {
          showToast('select at least one section');
          buildBtn.disabled = false;
          buildBtn.textContent = 'build showcase';
          return;
        }
        
        albums = Array(10).fill(null);
        
        displayShowcase();
        
      } catch (e) {
        console.error('Build error:', e);
        showToast('failed to load tracks');
      }
      
      buildBtn.disabled = false;
      buildBtn.textContent = 'build showcase';
    }

    function displayShowcase() {
      showSection('showcase');
      
      ownerName.textContent = showcaseTitle;
      headerLogo.textContent = showcaseTitle.split('').join(' ');
      
      if (showSongs) {
        songsSection.classList.remove('hidden');
        buildPyramid();
      } else {
        songsSection.classList.add('hidden');
      }
      
      if (showAlbums) {
        albumsSection.classList.remove('hidden');
        buildAlbums();
      } else {
        albumsSection.classList.add('hidden');
      }
      
      const hint = isSharedView ? 'click to play' : 'click to play · right-click to fix';
      nowPlaying.innerHTML = `<span style="color: var(--muted)">${hint}</span>`;
    }

    // ===== PYRAMID =====
    function calculatePyramidRows(count) {
      const rows = [];
      let remaining = count;
      let rowSize = 1;
      
      while (remaining > 0) {
        const size = Math.min(rowSize, remaining);
        rows.push(size);
        remaining -= size;
        rowSize += 2;
      }
      
      return rows;
    }

    function buildPyramid() {
      pyramid.innerHTML = '';
      const rows = calculatePyramidRows(tracks.length);
      let trackIndex = 0;
      
      rows.forEach((count, rowIndex) => {
        const row = document.createElement('div');
        row.className = 'pyramid-row';
        
        for (let i = 0; i < count; i++) {
          if (trackIndex < tracks.length) {
            const tile = createTile(trackIndex, rowIndex === 0);
            row.appendChild(tile);
            trackIndex++;
          }
        }
        
        pyramid.appendChild(row);
      });
    }

    function createTile(index, isHero) {
      const t = tracks[index];
      const tile = document.createElement('div');
      tile.className = 'tile' + (isHero ? ' hero' : '');
      tile.dataset.index = index;
      
      if (t.artwork) {
        tile.style.backgroundImage = `url(${t.artwork})`;
      }
      
      const badge = document.createElement('div');
      badge.className = 'rank-badge';
      badge.textContent = `#${index + 1}`;
      tile.appendChild(badge);
      
      tile.addEventListener('click', () => playTrack(index));
      
      if (!isSharedView) {
        tile.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          showContextMenu(e, index);
        });
      }
      
      return tile;
    }

    function updateTile(index) {
      const tile = pyramid.querySelector(`[data-index="${index}"]`);
      if (tile && tracks[index]) {
        tile.style.backgroundImage = `url(${tracks[index].artwork})`;
      }
    }

    // ===== ALBUMS =====
    function buildAlbums() {
      albumContainer.innerHTML = '';
      
      for (let i = 9; i >= 0; i--) {
        const strip = document.createElement('div');
        strip.className = 'album-strip';
        strip.dataset.index = i;
        
        const badge = document.createElement('div');
        badge.className = 'rank-badge';
        badge.textContent = `#${i + 1}`;
        strip.appendChild(badge);
        
        if (albums[i]) {
          strip.style.backgroundImage = `url(${albums[i].artwork})`;
          if (isSharedView) {
            strip.addEventListener('click', () => openAlbumLinks(i));
          }
        } else if (!isSharedView) {
          strip.style.cursor = 'pointer';
          strip.addEventListener('click', () => openAlbumModal(i));
        }
        
        albumContainer.appendChild(strip);
      }
    }

    function updateAlbumStrip(index) {
      const strip = albumContainer.querySelector(`[data-index="${index}"]`);
      if (strip && albums[index]) {
        strip.style.backgroundImage = `url(${albums[index].artwork})`;
        
        strip.onclick = null;
        if (isSharedView) {
          strip.addEventListener('click', () => openAlbumLinks(index));
        } else {
          strip.addEventListener('click', () => openAlbumModal(index));
        }
      }
    }

    // ===== AUDIO PLAYBACK =====
    function playTrack(index) {
      const t = tracks[index];
      
      if (currentPlaying?.index === index) {
        stopAudio();
        return;
      }
      
      stopAudio();
      
      if (t.preview) {
        audio.src = t.preview;
        audio.play();
        
        const tile = pyramid.querySelector(`[data-index="${index}"]`);
        if (tile) tile.classList.add('playing');
        
        currentPlaying = { index, tile };
        nowPlaying.innerHTML = `<strong>${t.trackName}</strong> - ${t.artistName}`;
      } else {
        if (t.spotifyUrl) {
          window.open(t.spotifyUrl, '_blank');
        }
        nowPlaying.innerHTML = `<span style="color: var(--muted)">no preview available</span>`;
      }
    }

    function stopAudio() {
      audio.pause();
      audio.src = '';
      if (currentPlaying?.tile) {
        currentPlaying.tile.classList.remove('playing');
      }
      currentPlaying = null;
      const hint = isSharedView ? 'click to play' : 'click to play · right-click to fix';
      nowPlaying.innerHTML = `<span style="color: var(--muted)">${hint}</span>`;
    }

    audio.addEventListener('ended', stopAudio);

    // ===== CONTEXT MENU =====
    function showContextMenu(e, index) {
      contextTarget = index;
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.classList.remove('hidden');
    }

    document.addEventListener('click', () => {
      contextMenu.classList.add('hidden');
    });

    fixSongBtn.addEventListener('click', () => {
      contextMenu.classList.add('hidden');
      openFixModal();
    });

    // ===== FIX SONG MODAL =====
    function openFixModal() {
      fixModal.classList.remove('hidden');
      fixSearchInput.value = '';
      fixSearchResults.innerHTML = '';
      fixSearchInput.focus();
    }

    function closeFixModal() {
      fixModal.classList.add('hidden');
    }

    fixModalClose.addEventListener('click', closeFixModal);
    fixModal.addEventListener('click', (e) => {
      if (e.target === fixModal) closeFixModal();
    });

    let fixSearchTimeout;
    fixSearchInput.addEventListener('input', () => {
      clearTimeout(fixSearchTimeout);
      const query = fixSearchInput.value.trim();
      if (query.length < 2) {
        fixSearchResults.innerHTML = '';
        return;
      }
      
      fixSearchTimeout = setTimeout(async () => {
        try {
          const results = await searchSpotify(query, 'track', 8);
          displayFixResults(results);
        } catch (e) {
          console.error('Search error:', e);
        }
      }, 300);
    });

    function displayFixResults(results) {
      if (!results.length) {
        fixSearchResults.innerHTML = '<p class="search-hint">no results found</p>';
        return;
      }
      
      fixSearchResults.innerHTML = results.map((r, i) => `
        <div class="search-result" data-index="${i}">
          <img class="search-result-img" src="${r.album?.images?.[0]?.url || ''}" alt="">
          <div class="search-result-info">
            <div class="search-result-name">${r.name}</div>
            <div class="search-result-artist">${r.artists.map(a => a.name).join(', ')}</div>
          </div>
        </div>
      `).join('');
      
      fixSearchResults.querySelectorAll('.search-result').forEach((el, i) => {
        el.addEventListener('click', () => selectFixResult(results[i]));
      });
    }

    function selectFixResult(r) {
      tracks[contextTarget] = {
        trackName: r.name,
        artistName: r.artists.map(a => a.name).join(', '),
        artwork: r.album?.images?.[0]?.url || '',
        preview: r.preview_url || '',
        spotifyUrl: r.external_urls?.spotify || '',
        albumName: r.album?.name || ''
      };
      updateTile(contextTarget);
      closeFixModal();
      showToast(`updated #${contextTarget + 1}`);
    }

    // ===== ALBUM MODAL =====
    function openAlbumModal(index) {
      albumTarget = index;
      albumModal.classList.remove('hidden');
      albumSearchInput.value = '';
      albumSearchResults.innerHTML = '';
      albumSearchInput.focus();
    }

    function closeAlbumModal() {
      albumModal.classList.add('hidden');
    }

    albumModalClose.addEventListener('click', closeAlbumModal);
    albumModal.addEventListener('click', (e) => {
      if (e.target === albumModal) closeAlbumModal();
    });

    let albumSearchTimeout;
    albumSearchInput.addEventListener('input', () => {
      clearTimeout(albumSearchTimeout);
      const query = albumSearchInput.value.trim();
      if (query.length < 2) {
        albumSearchResults.innerHTML = '';
        return;
      }
      
      albumSearchTimeout = setTimeout(async () => {
        try {
          const results = await searchSpotify(query, 'album', 8);
          displayAlbumResults(results);
        } catch (e) {
          console.error('Search error:', e);
        }
      }, 300);
    });

    function displayAlbumResults(results) {
      if (!results.length) {
        albumSearchResults.innerHTML = '<p class="search-hint">no results found</p>';
        return;
      }
      
      albumSearchResults.innerHTML = results.map((r, i) => `
        <div class="search-result" data-index="${i}">
          <img class="search-result-img" src="${r.images?.[0]?.url || ''}" alt="">
          <div class="search-result-info">
            <div class="search-result-name">${r.name}</div>
            <div class="search-result-artist">${r.artists.map(a => a.name).join(', ')}</div>
          </div>
        </div>
      `).join('');
      
      albumSearchResults.querySelectorAll('.search-result').forEach((el, i) => {
        el.addEventListener('click', () => selectAlbumResult(results[i]));
      });
    }

    function selectAlbumResult(r) {
      albums[albumTarget] = {
        albumName: r.name,
        artistName: r.artists.map(a => a.name).join(', '),
        artwork: r.images?.[0]?.url || '',
        spotifyUrl: r.external_urls?.spotify || ''
      };
      updateAlbumStrip(albumTarget);
      closeAlbumModal();
      showToast(`added album #${albumTarget + 1}`);
    }

    // ===== ALBUM LINKS (for shared view) =====
    function openAlbumLinks(index) {
      const album = albums[index];
      if (!album) return;
      
      albumLinksTitle.textContent = album.albumName;
      
      if (album.spotifyUrl) {
        openSpotifyBtn.href = album.spotifyUrl;
      } else {
        openSpotifyBtn.href = `https://open.spotify.com/search/${encodeURIComponent(album.albumName + ' ' + album.artistName)}`;
      }
      
      openAppleBtn.href = `https://music.apple.com/search?term=${encodeURIComponent(album.albumName + ' ' + album.artistName)}`;
      
      albumLinksModal.classList.remove('hidden');
    }

    albumLinksClose.addEventListener('click', () => {
      albumLinksModal.classList.add('hidden');
    });
    
    albumLinksModal.addEventListener('click', (e) => {
      if (e.target === albumLinksModal) {
        albumLinksModal.classList.add('hidden');
      }
    });

    // ===== SHARE/SAVE =====
    function generateShareData() {
      const albumsWithIndex = [];
      albums.forEach((a, i) => {
        if (a) {
          albumsWithIndex.push([
            i,
            a.albumName,
            a.artistName,
            a.artwork || '',
            a.spotifyUrl || ''
          ]);
        }
      });
      
      return {
        title: showcaseTitle,
        showSongs,
        showAlbums,
        tracks: showSongs ? tracks.map(t => [
          t.trackName,
          t.artistName,
          t.artwork || '',
          t.preview || '',
          t.spotifyUrl || ''
        ]) : [],
        albums: showAlbums ? albumsWithIndex : []
      };
    }

    async function saveAndShare() {
      const data = generateShareData();
      
      showToast('saving...');
      saveBtn.disabled = true;
      saveBtn.textContent = 'saving...';
      
      try {
        const jsonStr = JSON.stringify(data);
        const compressed = LZString.compressToEncodedURIComponent(jsonStr);
        const shareUrl = `${window.location.origin}${window.location.pathname}#${compressed}`;
        
        console.log('Share URL length:', shareUrl.length);
        
        showShareLink(shareUrl, shareUrl.length > 4000);
        
      } catch (e) {
        console.error('Save error:', e);
        showToast('save failed');
      }
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'save & get share link';
    }

    function showShareLink(url, isLong = false) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'shareModal';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h3>${isLong ? '⚠️ Long Link' : '✓ Saved Forever!'}</h3>
            <button class="modal-close" onclick="document.getElementById('shareModal').remove()">&times;</button>
          </div>
          <div class="modal-body">
            ${isLong ? '<p style="color:#e74c3c; font-size:12px; margin-bottom:10px;">This link is very long. Try copying to Notes first.</p>' : '<p style="color:#27ae60; font-size:12px; margin-bottom:10px;">This link will never expire!</p>'}
            <input type="text" class="search-input" value="${url}" readonly id="shareLinkInput" style="font-size:11px;">
            <button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="copyShareLink()">copy link</button>
            <p class="search-hint" id="copyStatus">click to copy</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      setTimeout(() => {
        const input = document.getElementById('shareLinkInput');
        if (input) input.select();
      }, 100);
    }

    window.copyShareLink = async function() {
      const input = document.getElementById('shareLinkInput');
      const status = document.getElementById('copyStatus');
      if (!input) return;
      
      try {
        await navigator.clipboard.writeText(input.value);
        status.textContent = '✓ copied!';
        status.style.color = '#27ae60';
        showToast('link copied!');
      } catch (e) {
        input.select();
        document.execCommand('copy');
        status.textContent = '✓ copied!';
        status.style.color = '#27ae60';
      }
    };

    // ===== LOAD FROM SHARE =====
    async function loadFromShare() {
      const hashData = location.hash.slice(1);
      
      if (!hashData || hashData.length === 0) {
        return false;
      }
      
      console.log('Loading from share link...');
      
      try {
        const decompressed = LZString.decompressFromEncodedURIComponent(hashData);
        if (!decompressed) return false;
        
        const data = JSON.parse(decompressed);
        
        if (!data.tracks?.length && !data.albums?.length) {
          return false;
        }
        
        showcaseTitle = data.title || '2025';
        showSongs = data.showSongs !== false;
        showAlbums = data.showAlbums !== false;
        
        if (data.tracks?.length) {
          tracks = data.tracks.map(t => ({
            trackName: t[0],
            artistName: t[1],
            artwork: t[2] || '',
            preview: t[3] || '',
            spotifyUrl: t[4] || ''
          }));
        }
        
        if (data.albums?.length) {
          albums = Array(10).fill(null);
          data.albums.forEach(a => {
            const idx = a[0];
            albums[idx] = {
              albumName: a[1],
              artistName: a[2],
              artwork: a[3] || '',
              spotifyUrl: a[4] || ''
            };
          });
        }
        
        return true;
        
      } catch (e) {
        console.error('Load error:', e);
        return false;
      }
    }

    // ===== EVENT LISTENERS =====
    connectBtn.addEventListener('click', startSpotifyAuth);
    logoutBtn.addEventListener('click', logout);
    
    topTracksBtn.addEventListener('click', () => {
      selectedSource = { type: 'top' };
      showSettings();
    });
    
    playlistBtn.addEventListener('click', showPlaylistSelection);
    backToSourceBtn.addEventListener('click', () => showSection('source'));
    backToPlaylistBtn.addEventListener('click', () => {
      if (selectedSource?.type === 'top') {
        showSection('source');
      } else {
        showSection('playlist');
      }
    });
    
    buildBtn.addEventListener('click', buildShowcase);
    saveBtn.addEventListener('click', saveAndShare);
    
    backBtn.addEventListener('click', () => {
      stopAudio();
      showSection('settings');
    });

    // ===== INIT =====
    (async function init() {
      // Check for shared view first
      if (await loadFromShare()) {
        isSharedView = true;
        saveBtn.style.display = 'none';
        displayShowcase();
        return;
      }
      
      // Check for auth callback
      if (await handleAuthCallback()) {
        await showSourceSelection();
        return;
      }
      
      // Check for stored token
      if (checkStoredToken()) {
        await showSourceSelection();
        return;
      }
      
      // Show connect screen
      showSection('connect');
    })();

    console.log('[2025] spotify version ready!');
  </script>
</body>
</html>

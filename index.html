<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2025</title>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f0;
      --text: #111;
      --muted: #888;
      --border: #111;
      --green: #7ecb8b;
      --green-dark: #5eb36d;
      --pink: #f28b82;
      --tile: 70px;
      --gap: 6px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier Prime', 'Courier New', monospace;
      padding-bottom: 80px;
    }

    /* Header */
    .header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      letter-spacing: 8px;
      font-weight: 400;
    }

    .logout-btn {
      font-size: 13px;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Tab Pills */
    .tab-pills {
      display: flex;
      justify-content: center;
      gap: 0;
      margin: 10px 20px 20px;
    }

    .tab-pill {
      padding: 10px 20px;
      border: 2px solid var(--border);
      background: #fff;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tab-pill:first-child {
      border-radius: 0;
    }

    .tab-pill:last-child {
      border-left: none;
    }

    .tab-pill.active {
      background: var(--green);
    }

    .tab-pill:hover:not(.active) {
      background: #eee;
    }

    /* Upload Section */
    .upload-section {
      max-width: 500px;
      margin: 60px auto;
      padding: 0 20px;
      text-align: center;
    }

    .upload-section h1 {
      font-size: 24px;
      letter-spacing: 6px;
      font-weight: 400;
      margin-bottom: 30px;
    }

    .upload-box {
      border: 2px solid var(--border);
      padding: 30px;
      background: #fff;
    }

    .file-row {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    input[type="file"] {
      border: 2px solid var(--border);
      padding: 12px;
      font-family: inherit;
      cursor: pointer;
      background: #fff;
      width: 100%;
    }

    .btn {
      background: #fff;
      color: var(--text);
      border: 2px solid var(--border);
      padding: 12px 24px;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 14px;
    }

    .btn:hover {
      background: var(--text);
      color: #fff;
    }

    .btn-green {
      background: var(--green);
      border-color: var(--green);
    }

    .btn-green:hover {
      background: var(--green-dark);
      border-color: var(--green-dark);
      color: #fff;
    }

    .btn-pink {
      background: var(--pink);
      border-color: var(--pink);
      color: #fff;
    }

    .status {
      margin-top: 15px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Main Layout */
    .main-layout {
      display: flex;
      gap: 40px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      justify-content: center;
    }

    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
        align-items: center;
        gap: 30px;
      }
    }

    /* Songs Section */
    .songs-section {
      flex: 0 0 auto;
    }

    .section-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 3px;
      margin-bottom: 15px;
      text-align: center;
    }

    .pyramid-container {
      border: 2px solid var(--border);
      background: #fff;
      padding: 20px;
    }

    .pyramid {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--gap);
    }

    .pyr-row {
      display: flex;
      justify-content: center;
      gap: var(--gap);
    }

    .tile {
      width: var(--tile);
      height: var(--tile);
      border: 2px solid var(--border);
      overflow: hidden;
      cursor: pointer;
      position: relative;
      background: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .tile:hover {
      transform: scale(1.08);
      z-index: 10;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .tile.playing {
      box-shadow: 0 0 0 3px var(--green), 0 6px 20px rgba(126,203,139,0.4);
    }

    .tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tile .rank {
      position: absolute;
      top: 2px;
      left: 2px;
      font-size: 8px;
      font-weight: 700;
      color: var(--text);
      background: rgba(255,255,255,0.9);
      padding: 1px 3px;
    }

    .tile.hero {
      width: calc(var(--tile) * 2);
      height: calc(var(--tile) * 2);
    }

    .tile.hero .rank {
      font-size: 11px;
      padding: 2px 5px;
    }

    /* Now Playing */
    .now-playing {
      text-align: center;
      margin-top: 12px;
      padding: 12px;
      border: 2px solid var(--border);
      background: #fff;
      font-size: 12px;
    }

    .now-playing .song-title {
      font-weight: 700;
    }

    .now-playing .song-artist {
      color: var(--muted);
    }

    /* Albums Section */
    .albums-section {
      flex: 0 0 280px;
    }

    .album-strip-container {
      border: 2px solid var(--border);
      background: #fff;
      overflow: hidden;
    }

    .album-strip {
      width: 100%;
      height: 70px;
      border-bottom: 2px solid var(--border);
      cursor: pointer;
      position: relative;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
      overflow: hidden;
    }

    .album-strip:last-child {
      border-bottom: none;
    }

    .album-strip:hover {
      opacity: 0.85;
    }

    .album-strip img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .album-strip .album-rank {
      position: absolute;
      top: 50%;
      left: 8px;
      transform: translateY(-50%);
      background: #fff;
      font-size: 11px;
      font-weight: 700;
      padding: 3px 6px;
      border: 1px solid var(--border);
    }

    .album-strip .placeholder-text {
      font-size: 11px;
      color: var(--muted);
    }

    /* Share Bar */
    .share-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      padding: 0 20px;
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: #fff;
      border: 2px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      min-width: 160px;
    }

    .context-menu-item {
      padding: 10px 14px;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 1px solid #eee;
    }

    .context-menu-item:last-child {
      border-bottom: none;
    }

    .context-menu-item:hover {
      background: #f5f5f5;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: #fff;
      border: 2px solid var(--border);
      width: 100%;
      max-width: 450px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 2px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 16px;
      letter-spacing: 2px;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    .search-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border);
      font-family: inherit;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--green);
    }

    .or-divider {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      margin: 12px 0;
      position: relative;
    }

    .or-divider::before,
    .or-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #ddd;
    }

    .or-divider::before { left: 0; }
    .or-divider::after { right: 0; }

    .link-input-section {
      margin-bottom: 15px;
    }

    .link-input-row {
      display: flex;
      gap: 8px;
    }

    .link-input-row input {
      flex: 1;
    }

    .search-results {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }

    .search-result {
      display: flex;
      gap: 10px;
      padding: 8px;
      border: 2px solid #eee;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .search-result:hover {
      border-color: var(--border);
    }

    .search-result img {
      width: 45px;
      height: 45px;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    .search-result-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .search-result-title {
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-result-artist {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-hint {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
      padding: 15px;
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 2px solid var(--border);
      display: flex;
      justify-content: center;
      padding: 12px 20px;
      gap: 30px;
    }

    .nav-item {
      font-size: 13px;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      transition: color 0.15s;
    }

    .nav-item:hover,
    .nav-item.active {
      color: var(--text);
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid var(--border);
      padding: 10px 18px;
      font-size: 12px;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Hidden */
    .hidden { display: none !important; }

    /* Loading */
    .tile-placeholder {
      background: linear-gradient(90deg, #eee 25%, #ddd 50%, #eee 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Responsive */
    @media (max-width: 600px) {
      :root {
        --tile: 52px;
      }
      .section-title {
        font-size: 22px;
      }
      .albums-section {
        flex: 0 0 100%;
        width: 100%;
        max-width: 300px;
      }
      .logo {
        font-size: 18px;
        letter-spacing: 5px;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="logo">2 0 2 5</div>
    <a href="#" class="logout-btn" id="backBtn">← back</a>
  </header>

  <!-- Upload Section -->
  <section class="upload-section" id="uploadSection">
    <h1>2 0 2 5</h1>
    <div class="upload-box">
      <div class="file-row">
        <input type="file" id="csvFile" accept=".csv">
        <button class="btn btn-green" id="buildBtn">build showcase</button>
      </div>
      <p class="status" id="status">export your spotify playlist as csv</p>
    </div>
  </section>

  <!-- Showcase Section -->
  <section class="hidden" id="showcaseSection">
    <div class="share-bar">
      <button class="btn" id="shareBtn">share link</button>
    </div>

    <div class="main-layout">
      <!-- Songs -->
      <div class="songs-section">
        <h2 class="section-title">SONGS</h2>
        <div class="pyramid-container">
          <div class="pyramid" id="pyramid"></div>
        </div>
        <div class="now-playing" id="nowPlaying">
          <span style="color: var(--muted)">click to play · right-click to fix</span>
        </div>
      </div>

      <!-- Albums -->
      <div class="albums-section">
        <h2 class="section-title">ALBUMS</h2>
        <div class="album-strip-container" id="albumContainer"></div>
      </div>
    </div>
  </section>

  <!-- Context Menu -->
  <div class="context-menu hidden" id="contextMenu">
    <div class="context-menu-item" id="fixSongBtn">fix this song</div>
  </div>

  <!-- Fix Song Modal -->
  <div class="modal-overlay hidden" id="fixModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Fix Song</h3>
        <button class="modal-close" id="fixModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" class="search-input" id="fixSearchInput" placeholder="search itunes...">
        
        <div class="or-divider">or paste link</div>
        
        <div class="link-input-section">
          <div class="link-input-row">
            <input type="text" class="search-input" id="fixLinkInput" placeholder="paste itunes song link..." style="margin-bottom:0">
            <button class="btn btn-green" id="fixLinkBtn">apply</button>
          </div>
        </div>
        
        <div class="search-results" id="fixSearchResults"></div>
        <p class="search-hint" id="fixHint">type to search or paste an itunes link</p>
      </div>
    </div>
  </div>

  <!-- Album Search Modal -->
  <div class="modal-overlay hidden" id="albumModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Add Album</h3>
        <button class="modal-close" id="albumModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" class="search-input" id="albumSearchInput" placeholder="search itunes...">
        
        <div class="or-divider">or paste link</div>
        
        <div class="link-input-section">
          <div class="link-input-row">
            <input type="text" class="search-input" id="albumLinkInput" placeholder="paste itunes album link..." style="margin-bottom:0">
            <button class="btn btn-green" id="albumLinkBtn">apply</button>
          </div>
        </div>
        
        <div class="search-results" id="albumSearchResults"></div>
        <p class="search-hint" id="albumHint">type to search or paste an itunes link</p>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <span class="nav-item active">2025</span>
  </nav>

  <div class="toast hidden" id="toast"></div>
  <audio id="audio" preload="none"></audio>

  <script>
    // ===== ELEMENTS =====
    const $ = id => document.getElementById(id);
    const csvFile = $('csvFile');
    const buildBtn = $('buildBtn');
    const backBtn = $('backBtn');
    const shareBtn = $('shareBtn');
    const status = $('status');
    const uploadSection = $('uploadSection');
    const showcaseSection = $('showcaseSection');
    const pyramid = $('pyramid');
    const nowPlaying = $('nowPlaying');
    const albumContainer = $('albumContainer');
    const toast = $('toast');
    const audio = $('audio');
    const contextMenu = $('contextMenu');
    const fixSongBtn = $('fixSongBtn');
    const fixModal = $('fixModal');
    const fixModalClose = $('fixModalClose');
    const fixSearchInput = $('fixSearchInput');
    const fixSearchResults = $('fixSearchResults');
    const fixLinkInput = $('fixLinkInput');
    const fixLinkBtn = $('fixLinkBtn');
    const fixHint = $('fixHint');
    const albumModal = $('albumModal');
    const albumModalClose = $('albumModalClose');
    const albumSearchInput = $('albumSearchInput');
    const albumSearchResults = $('albumSearchResults');
    const albumLinkInput = $('albumLinkInput');
    const albumLinkBtn = $('albumLinkBtn');
    const albumHint = $('albumHint');

    // ===== STATE =====
    let tracks = [];
    let albums = Array(10).fill(null);
    let currentPlaying = null;
    let contextTarget = null;
    let editingAlbumIndex = null;

    // ===== TOAST =====
    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.remove('hidden');
      clearTimeout(showToast.t);
      showToast.t = setTimeout(() => toast.classList.add('hidden'), 2000);
    }

    // ===== CSV PARSING =====
    function parseCSV(text) {
      if (!text) return [];
      text = text.replace(/^\uFEFF/, '');
      const rows = [];
      let row = [], cell = '', inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const ch = text[i], next = text[i + 1];
        if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }
        if (ch === ',' && !inQuotes) { row.push(cell); cell = ''; continue; }
        if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && next === '\n') i++;
          row.push(cell); cell = '';
          if (row.some(c => c.trim())) rows.push(row);
          row = [];
          continue;
        }
        cell += ch;
      }
      row.push(cell);
      if (row.some(c => c.trim())) rows.push(row);
      return rows;
    }

    function extractTracks(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];

      const header = rows[0].map(h => h.toLowerCase().trim());
      const trackIdx = header.findIndex(h => h.includes('track name'));
      const artistIdx = header.findIndex(h => h.includes('artist'));
      const albumIdx = header.findIndex(h => h.includes('album'));

      if (trackIdx === -1 || artistIdx === -1) return [];

      const out = [];
      for (let i = 1; i < rows.length && out.length < 25; i++) {
        const cells = rows[i];
        const track = (cells[trackIdx] || '').trim();
        const artist = (cells[artistIdx] || '').trim();
        const album = albumIdx !== -1 ? (cells[albumIdx] || '').trim() : '';
        if (track && artist) out.push({ track, artist, album });
      }
      
      // REVERSE the order so last in CSV = #1
      return out.reverse();
    }

    // ===== iTUNES API =====
    let jsonpCounter = 0;
    
    function jsonpFetch(url) {
      return new Promise((resolve, reject) => {
        const callbackName = `cb_${jsonpCounter++}_${Date.now()}`;
        const script = document.createElement('script');
        
        const cleanup = () => {
          delete window[callbackName];
          script.remove();
        };
        
        window[callbackName] = (data) => {
          cleanup();
          resolve(data);
        };
        
        script.onerror = () => {
          cleanup();
          reject(new Error('Request failed'));
        };
        
        script.src = `${url}&callback=${callbackName}`;
        document.head.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            cleanup();
            reject(new Error('Timeout'));
          }
        }, 10000);
      });
    }

    async function searchItunes(query, entity = 'song', limit = 5) {
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=${entity}&limit=${limit}`;
      try {
        const data = await jsonpFetch(url);
        return data.results || [];
      } catch (e) {
        try {
          const resp = await fetch(url);
          const data = await resp.json();
          return data.results || [];
        } catch (e2) {
          console.error('Search failed:', e2);
          return [];
        }
      }
    }

    // Parse iTunes ID from link
    function parseItunesId(link) {
      // Handles: https://music.apple.com/us/album/song-name/123456789?i=987654321
      // Or: https://itunes.apple.com/us/album/id123456789
      const match = link.match(/[?&]i=(\d+)/);
      if (match) return { type: 'song', id: match[1] };
      
      const albumMatch = link.match(/\/album\/[^/]+\/(\d+)/);
      if (albumMatch) return { type: 'album', id: albumMatch[1] };
      
      const idMatch = link.match(/id(\d+)/);
      if (idMatch) return { type: 'unknown', id: idMatch[1] };
      
      return null;
    }

    async function lookupItunes(id) {
      const url = `https://itunes.apple.com/lookup?id=${id}`;
      try {
        const data = await jsonpFetch(url);
        return data.results?.[0] || null;
      } catch (e) {
        try {
          const resp = await fetch(url);
          const data = await resp.json();
          return data.results?.[0] || null;
        } catch (e2) {
          console.error('Lookup failed:', e2);
          return null;
        }
      }
    }

    async function searchSong(track, artist) {
      const results = await searchItunes(`${track} ${artist.split(',')[0]}`, 'song', 3);
      if (results.length) {
        const best = results[0];
        return {
          artwork: (best.artworkUrl100 || '').replace('100x100bb', '300x300bb'),
          preview: best.previewUrl || '',
          trackName: best.trackName,
          artistName: best.artistName
        };
      }
      return null;
    }

    // ===== AUDIO =====
    function stopAudio() {
      audio.pause();
      audio.src = '';
      if (currentPlaying) {
        currentPlaying.tile.classList.remove('playing');
        currentPlaying = null;
      }
      nowPlaying.innerHTML = '<span style="color: var(--muted)">click to play · right-click to fix</span>';
    }

    function playTrack(index, tile) {
      const t = tracks[index];
      if (!t?.preview) {
        showToast('no preview available');
        return;
      }

      if (currentPlaying?.index === index) {
        stopAudio();
        return;
      }

      stopAudio();
      currentPlaying = { index, tile };
      tile.classList.add('playing');
      audio.src = t.preview;
      audio.play().catch(() => {});
      
      nowPlaying.innerHTML = `
        <div class="song-title">${t.trackName || t.track}</div>
        <div class="song-artist">${t.artistName || t.artist}</div>
      `;
    }

    audio.addEventListener('ended', stopAudio);

    // ===== BUILD PYRAMID =====
    const PYRAMID_ROWS = [1, 3, 5, 7, 9];

    function buildPyramid() {
      pyramid.innerHTML = '';
      let idx = 0;

      PYRAMID_ROWS.forEach((count) => {
        const row = document.createElement('div');
        row.className = 'pyr-row';

        for (let i = 0; i < count && idx < 25; i++) {
          const tile = document.createElement('div');
          tile.className = 'tile' + (idx === 0 ? ' hero' : '');
          tile.dataset.index = idx;

          const t = tracks[idx];
          if (t?.artwork) {
            tile.innerHTML = `
              <img src="${t.artwork}" alt="${t.track}">
              <span class="rank">#${idx + 1}</span>
            `;
          } else {
            tile.innerHTML = `<span class="rank">#${idx + 1}</span>`;
            tile.classList.add('tile-placeholder');
          }

          tile.addEventListener('click', () => playTrack(parseInt(tile.dataset.index), tile));
          tile.addEventListener('contextmenu', (e) => showContextMenu(e, parseInt(tile.dataset.index)));
          row.appendChild(tile);
          idx++;
        }

        pyramid.appendChild(row);
      });
    }

    function updateTile(index) {
      const tile = pyramid.querySelector(`[data-index="${index}"]`);
      const t = tracks[index];
      if (tile && t?.artwork) {
        tile.classList.remove('tile-placeholder');
        tile.innerHTML = `
          <img src="${t.artwork}" alt="${t.track}">
          <span class="rank">#${index + 1}</span>
        `;
      }
    }

    // ===== BUILD ALBUMS =====
    function buildAlbums() {
      albumContainer.innerHTML = '';
      for (let i = 0; i < 10; i++) {
        const strip = document.createElement('div');
        strip.className = 'album-strip';
        strip.dataset.index = i;

        const album = albums[i];
        if (album?.artwork) {
          strip.innerHTML = `
            <img src="${album.artwork}" alt="${album.albumName}">
            <span class="album-rank">#${i + 1}</span>
          `;
        } else {
          strip.innerHTML = `
            <span class="album-rank">#${i + 1}</span>
            <span class="placeholder-text">click to add</span>
          `;
        }

        strip.addEventListener('click', () => openAlbumModal(i));
        albumContainer.appendChild(strip);
      }
    }

    function updateAlbumStrip(index) {
      const strip = albumContainer.querySelector(`[data-index="${index}"]`);
      const album = albums[index];
      if (strip && album?.artwork) {
        strip.innerHTML = `
          <img src="${album.artwork}" alt="${album.albumName}">
          <span class="album-rank">#${index + 1}</span>
        `;
      }
    }

    // ===== CONTEXT MENU =====
    function showContextMenu(e, index) {
      e.preventDefault();
      contextTarget = index;
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.classList.remove('hidden');
    }

    function hideContextMenu() {
      contextMenu.classList.add('hidden');
    }

    document.addEventListener('click', hideContextMenu);

    fixSongBtn.addEventListener('click', () => {
      if (contextTarget !== null) {
        openFixModal(contextTarget);
      }
      hideContextMenu();
    });

    // ===== FIX SONG MODAL =====
    function openFixModal(index) {
      contextTarget = index;
      const t = tracks[index];
      fixSearchInput.value = `${t.track} ${t.artist}`;
      fixLinkInput.value = '';
      fixSearchResults.innerHTML = '';
      fixHint.classList.remove('hidden');
      fixModal.classList.remove('hidden');
      fixSearchInput.focus();
      doFixSearch();
    }

    function closeFixModal() {
      fixModal.classList.add('hidden');
      contextTarget = null;
    }

    fixModalClose.addEventListener('click', closeFixModal);
    fixModal.addEventListener('click', (e) => {
      if (e.target === fixModal) closeFixModal();
    });

    let fixSearchTimeout;
    fixSearchInput.addEventListener('input', () => {
      clearTimeout(fixSearchTimeout);
      fixSearchTimeout = setTimeout(doFixSearch, 400);
    });

    async function doFixSearch() {
      const query = fixSearchInput.value.trim();
      if (!query) {
        fixSearchResults.innerHTML = '';
        fixHint.classList.remove('hidden');
        return;
      }

      fixHint.textContent = 'searching...';
      const results = await searchItunes(query, 'song', 8);

      if (!results.length) {
        fixSearchResults.innerHTML = '';
        fixHint.textContent = 'no results found';
        fixHint.classList.remove('hidden');
        return;
      }

      fixHint.classList.add('hidden');
      fixSearchResults.innerHTML = results.map((r, i) => `
        <div class="search-result" data-idx="${i}">
          <img src="${r.artworkUrl100 || ''}" alt="">
          <div class="search-result-info">
            <div class="search-result-title">${r.trackName}</div>
            <div class="search-result-artist">${r.artistName}</div>
          </div>
        </div>
      `).join('');

      fixSearchResults.querySelectorAll('.search-result').forEach((el, i) => {
        el.addEventListener('click', () => selectFixResult(results[i]));
      });
    }

    function selectFixResult(r) {
      tracks[contextTarget] = {
        ...tracks[contextTarget],
        artwork: (r.artworkUrl100 || '').replace('100x100bb', '300x300bb'),
        preview: r.previewUrl || '',
        trackName: r.trackName,
        artistName: r.artistName
      };
      updateTile(contextTarget);
      closeFixModal();
      showToast(`updated #${contextTarget + 1}`);
    }

    // Fix via link
    fixLinkBtn.addEventListener('click', async () => {
      const link = fixLinkInput.value.trim();
      if (!link) return;

      const parsed = parseItunesId(link);
      if (!parsed) {
        showToast('invalid itunes link');
        return;
      }

      fixHint.textContent = 'loading...';
      fixHint.classList.remove('hidden');
      
      const result = await lookupItunes(parsed.id);
      if (result && result.wrapperType === 'track') {
        selectFixResult(result);
      } else {
        showToast('could not find song');
        fixHint.textContent = 'type to search or paste an itunes link';
      }
    });

    // ===== ALBUM SEARCH MODAL =====
    function openAlbumModal(index) {
      editingAlbumIndex = index;
      albumSearchInput.value = '';
      albumLinkInput.value = '';
      albumSearchResults.innerHTML = '';
      albumHint.textContent = 'type to search or paste an itunes link';
      albumHint.classList.remove('hidden');
      albumModal.classList.remove('hidden');
      albumSearchInput.focus();
    }

    function closeAlbumModal() {
      albumModal.classList.add('hidden');
      editingAlbumIndex = null;
    }

    albumModalClose.addEventListener('click', closeAlbumModal);
    albumModal.addEventListener('click', (e) => {
      if (e.target === albumModal) closeAlbumModal();
    });

    let albumSearchTimeout;
    albumSearchInput.addEventListener('input', () => {
      clearTimeout(albumSearchTimeout);
      albumSearchTimeout = setTimeout(doAlbumSearch, 400);
    });

    async function doAlbumSearch() {
      const query = albumSearchInput.value.trim();
      if (!query) {
        albumSearchResults.innerHTML = '';
        albumHint.classList.remove('hidden');
        return;
      }

      albumHint.textContent = 'searching...';
      albumHint.classList.remove('hidden');
      
      // Fetch more results so we have enough after filtering out singles
      const rawResults = await searchItunes(query, 'album', 25);
      
      // Filter to only show full albums (not singles/EPs)
      const results = rawResults.filter(r => 
        r.collectionType === 'Album' && 
        r.trackCount > 4  // Albums typically have more than 4 tracks
      ).slice(0, 8);

      if (!results.length) {
        albumSearchResults.innerHTML = '';
        albumHint.textContent = 'no albums found';
        albumHint.classList.remove('hidden');
        return;
      }

      albumHint.classList.add('hidden');
      albumSearchResults.innerHTML = results.map((r, i) => `
        <div class="search-result" data-idx="${i}">
          <img src="${r.artworkUrl100 || ''}" alt="">
          <div class="search-result-info">
            <div class="search-result-title">${r.collectionName}</div>
            <div class="search-result-artist">${r.artistName}</div>
          </div>
        </div>
      `).join('');

      albumSearchResults.querySelectorAll('.search-result').forEach((el, i) => {
        el.addEventListener('click', () => selectAlbumResult(results[i]));
      });
    }

    function selectAlbumResult(r) {
      albums[editingAlbumIndex] = {
        artwork: (r.artworkUrl100 || '').replace('100x100bb', '600x600bb'),
        albumName: r.collectionName,
        artistName: r.artistName
      };
      updateAlbumStrip(editingAlbumIndex);
      closeAlbumModal();
      showToast(`added #${editingAlbumIndex + 1}`);
    }

    // Album via link
    albumLinkBtn.addEventListener('click', async () => {
      const link = albumLinkInput.value.trim();
      if (!link) return;

      const parsed = parseItunesId(link);
      if (!parsed) {
        showToast('invalid itunes link');
        return;
      }

      albumHint.textContent = 'loading...';
      albumHint.classList.remove('hidden');
      
      const result = await lookupItunes(parsed.id);
      if (result && result.wrapperType === 'collection') {
        selectAlbumResult(result);
      } else {
        showToast('could not find album');
        albumHint.textContent = 'type to search or paste an itunes link';
      }
    });

    // ===== SHARE =====
    function generateShareData() {
      // Only store names - we'll re-fetch artwork when loading
      return {
        t: tracks.map(t => [
          t.trackName || t.track,
          t.artistName || t.artist
        ]),
        a: albums.filter(Boolean).map(a => [
          a.albumName,
          a.artistName
        ])
      };
    }

    function encodeShareData(data) {
      try {
        const json = JSON.stringify(data);
        return btoa(unescape(encodeURIComponent(json)));
      } catch (e) {
        console.error('Encode error:', e);
        return null;
      }
    }

    function decodeShareData(str) {
      try {
        const json = decodeURIComponent(escape(atob(str)));
        return JSON.parse(json);
      } catch (e) {
        console.error('Decode error:', e);
        return null;
      }
    }

    async function copyShareLink() {
      const data = generateShareData();
      const encoded = encodeShareData(data);
      
      if (!encoded) {
        showToast('error creating share link');
        return;
      }
      
      const url = `${location.origin}${location.pathname}?s=${encoded}`;
      
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          showToast('link copied!');
          return;
        }
      } catch (e) {
        console.log('Clipboard API failed, trying fallback');
      }
      
      try {
        const textarea = document.createElement('textarea');
        textarea.value = url;
        textarea.style.position = 'fixed';
        textarea.style.left = '-9999px';
        textarea.style.top = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        const success = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (success) {
          showToast('link copied!');
        } else {
          showToast('copy failed - try manually');
          console.log('Share URL:', url);
        }
      } catch (e) {
        showToast('copy failed');
        console.error('Copy error:', e);
        console.log('Share URL:', url);
      }
    }

    async function loadFromShare() {
      const params = new URLSearchParams(location.search);
      const shareData = params.get('s');
      if (!shareData) return false;

      const data = decodeShareData(shareData);
      if (!data?.t?.length) return false;

      // Load track names (artwork will be fetched after)
      tracks = data.t.map(t => ({
        track: t[0],
        artist: t[1],
        trackName: t[0],
        artistName: t[1],
        artwork: '',
        preview: ''
      }));

      // Load album names (artwork will be fetched after)
      if (data.a?.length) {
        data.a.forEach((a, i) => {
          albums[i] = {
            albumName: a[0],
            artistName: a[1],
            artwork: ''
          };
        });
      }

      return true;
    }

    async function fetchSharedArtwork() {
      // Fetch song artwork
      for (let i = 0; i < tracks.length; i++) {
        const result = await searchSong(tracks[i].track, tracks[i].artist);
        if (result) {
          tracks[i] = { ...tracks[i], ...result };
          updateTile(i);
        }
      }
      
      // Fetch album artwork
      for (let i = 0; i < albums.length; i++) {
        if (albums[i] && !albums[i].artwork) {
          const results = await searchItunes(`${albums[i].albumName} ${albums[i].artistName}`, 'album', 1);
          if (results.length) {
            albums[i].artwork = (results[0].artworkUrl100 || '').replace('100x100bb', '600x600bb');
            updateAlbumStrip(i);
          }
        }
      }
    }

    // ===== MAIN BUILD =====
    async function handleBuild() {
      const file = csvFile.files?.[0];
      if (!file) {
        status.textContent = 'select a csv file first';
        return;
      }

      status.textContent = 'reading file...';
      const text = await file.text();
      const parsed = extractTracks(text);

      if (!parsed.length) {
        status.textContent = 'could not find track data in csv';
        return;
      }

      status.textContent = `found ${parsed.length} tracks`;
      tracks = parsed.map(p => ({ ...p, artwork: '', preview: '' }));
      albums = Array(10).fill(null);

      showShowcase();

      for (let i = 0; i < tracks.length; i++) {
        const result = await searchSong(tracks[i].track, tracks[i].artist);
        if (result) {
          tracks[i] = { ...tracks[i], ...result };
          updateTile(i);
        }
        status.textContent = `loading ${i + 1}/${tracks.length}...`;
      }

      status.textContent = 'done!';
      showToast('showcase ready!');
    }

    function showShowcase() {
      uploadSection.classList.add('hidden');
      showcaseSection.classList.remove('hidden');
      backBtn.classList.remove('hidden');
      buildPyramid();
      buildAlbums();
    }

    function handleBack() {
      stopAudio();
      uploadSection.classList.remove('hidden');
      showcaseSection.classList.add('hidden');
      history.replaceState(null, '', location.pathname);
    }

    // ===== EVENT LISTENERS =====
    buildBtn.addEventListener('click', handleBuild);
    backBtn.addEventListener('click', handleBack);
    shareBtn.addEventListener('click', () => copyShareLink());

    // ===== INIT =====
    (async function init() {
      if (await loadFromShare()) {
        showShowcase();
        showToast('loading shared showcase...');
        await fetchSharedArtwork();
        showToast('loaded!');
      } else {
        backBtn.classList.add('hidden');
      }
    })();

    console.log('[2025] ready!');
  </script>
</body>
</html>
